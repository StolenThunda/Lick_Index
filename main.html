<script>
    function output_table(data) {
        json = JSON.parse(data)
        // CREATE DYNAMIC TABLE.
        var table = document.createElement("table");
        var header = table.createTHead();
        var row = header.insertRow(0);
        var headers = Object.keys(json.records[0]);
        var cell;
        for (var i = 0; i < headers.length; i++) {
            cell = row.insertCell(i);
            cell.innerHTML = '<b>' + headers[i] + '</b>'
        }


        // ADD JSON DATA TO THE TABLE AS ROWS.
        for (var i = 0; i < json.records.length; i++) {
            cur_vals = Object.values(json.records[i]);
            tr = table.insertRow(-1);
            for (var j = 0; j < cur_vals.length; j++) {
                var tabCell = tr.insertCell(-1);
                tabCell.innerHTML = cur_vals[j];
            }
        }


        // FINALLY ADD THE NEWLY CREATED TABLE WITH JSON DATA TO A CONTAINER.
        var divContainer = document.getElementById("output");
        divContainer.innerHTML = "";
        divContainer.appendChild(table);
    }

    function createDefaultTooltips() {
        var defaults = {
            title: `Course Title 
                              The sheet names in the attached Spreadsheet`,
            lick: `Lick Name
                             Short Name of the lick 
                             (eg. Solo 1 Lick 7, S1L7,
                             Chorus 3 Lick 5, C3L5,
                             Lesson 1 Pattern 3, L1P3)`

        };
        var course_title = document.createElement("PRE");
        course_title.id = "tip_course_title";
        course_title.innerHTML = defaults['title'];

        var lbl_lick = document.createElement("PRE");
        lbl_lick.id = 'tip_lbl_lick';
        lbl_lick.innerHTML = defaults['lick']

        var tips = document.getElementById('tip_container');
        tips.appendChild(course_title);
        tips.appendChild(lbl_lick);

    }

    function labels() {
        createDefaultTooltips();
        var suffix = "";
        $('form label').each(function (index) {
            suffix = this.htmlFor;
            tip = $('#tip_' + suffix);
            this.title = (tip) ? tip.html() : '';
        });
    }

    // Prevent forms from submitting.
    function preventFormSubmit() {
        var forms = document.querySelectorAll('form');
        for (var i = 0; i < forms.length; i++) {
            forms[i].addEventListener('submit', function (event) {
                event.preventDefault();
            });
        }
    }

    function handleFormSubmit(formObject) {
        console.log(formObject);
        google.script.run.processForm(formObject);
        document.getElementById("myForm").reset();
    }

    function clearList(select) {
        var length = select.options.length - 1;
        $.each(select.options, function (index, value) {
            alert(index + ": " + value);
        });
        //     for (i = 0; i < length; i++) {
        //            if (select.option[i].text !== '--') select.options[i].remove();
        //     }
    }

    function getLicks(e) {
        var title = e.options[e.selectedIndex].text;
        google.script.run
            .withFailureHandler(onFailure)
            .withSuccessHandler(addListValues)
            .licks_for_course(title);
    }

    function addList() {
        google.script.run
            .withFailureHandler(onFailure)
            .withSuccessHandler(addListValues)
            .sheetnames();
        labels()
    }

    function addListValues(values) {
        var el = values[1];
        values = values[0];
        var list = document.getElementById(el);
        clearList(list);
        for (var i = 0; i < values.length; i++) {
            var option = document.createElement("OPTION");
            option.value = values[i];
            option.text = values[i];
            list.appendChild(option);
        }
    }

    function onFailure(err) {
        alert('There was an error!' + err.message);
    }

    function doAction(btn) {
        var title = document.getElementById('course_title').value
        var lick = document.getElementById('lbl_lick').value
        switch (btn.name) {
            case 'read':
                if (title !== '--' && lick !== '') {
                    toggleInsert('update');
                    google.script.run
                        .withFailureHandler(onFailure)
                        .withSuccessHandler(populateForm)
                        .read_value(title, lick);
                    $('#chart').show();
                    break;
                }
                alert('Title and Lick required for this search')
                break;
            case 'dump':
                if (title !== '--') {
                    google.script.run
                        .withFailureHandler(onFailure)
                        .withSuccessHandler(output_table)
                        .read_all_values(title);
                    break;
                }
                alert('Choose A course')
                break;
            case 'delete':
            case 'update':
                toggleInsert();
                $('#chart').show();
                break;
            default:
                toggleInsert();
                $('#chart').hide();
                handleFormSubmit($(btn).parent('form')[0]);
        }
        if (title !== '--' && lick !== '') {
            updateChart(title, lick);
        }

    }

    function updateChart(title, lick) {
        var title = title || document.getElementById('course_title').value
        var lick = lick || document.getElementById('lbl_lick').value
        google.script.run
            .withFailureHandler(onFailure)
            .withSuccessHandler(test)
            .update_chart(title, lick);
    }

    function toggleInsert(name) {
        var toggle = (name !== 'update');
        $('input[name=create]').toggle(toggle)
        $('input[name=update]').toggle(!toggle)

    }


    function populateForm(data) {
        Object.entries(data).forEach(function (key, value) {
            value = key[1];
            key = key[0]
            if (key !== '') {
                var ctrl = $('#' + key);
                switch (ctrl.prop("type")) {
                    case "radio":
                    case "checkbox":
                        ctrl.each(function () {
                            if ($(this).attr('value') !== value) $(this).attr("checked", value);
                        });
                        break;
                    default:
                        ctrl.val(value);
                }
            }
        });
    }



    function test(data) {

        //alert(data)
    }
    window.addEventListener('load', preventFormSubmit);
    window.addEventListener('load', addList);
    //window.addEventListener('load', test);
    toggleInsert();
</script>