<script>
    function output_table(data) {
        json = JSON.parse(data)
        // CREATE DYNAMIC TABLE.
        var table = document.createElement("table");
        var header = table.createTHead();
        var row = header.insertRow(0);
        var headers = Object.keys(json.records[0]);
        var cell;
        for (var i = 0; i < headers.length; i++) {
            cell = row.insertCell(i);
            cell.innerHTML = '<b>' + headers[i] + '</b>'
        }


        // ADD JSON DATA TO THE TABLE AS ROWS.
        for (var i = 0; i < json.records.length; i++) {
            cur_vals = Object.values(json.records[i]);
            tr = table.insertRow(-1);
            for (var j = 0; j < cur_vals.length; j++) {
                var tabCell = tr.insertCell(-1);
                tabCell.innerHTML = cur_vals[j];
            }
        }


        // FINALLY ADD THE NEWLY CREATED TABLE WITH JSON DATA TO A CONTAINER.
        var divContainer = document.getElementById("output");
        divContainer.innerHTML = "";
        divContainer.appendChild(table);
    }

    function createDefaultTooltips() {
        var defaults = {
            title: `Course Title 
                              The sheet names in the attached Spreadsheet`,
            lick: `Lick Name
                             Short Name of the lick 
                             (eg. Solo 1 Lick 7, S1L7,
                             Chorus 3 Lick 5, C3L5,
                             Lesson 1 Pattern 3, L1P3)`

        };
        var course_title = document.createElement("PRE");
        course_title.id = "tip_course_title";
        course_title.innerHTML = defaults['title'];

        var lbl_lick = document.createElement("PRE");
        lbl_lick.id = 'tip_lbl_lick';
        lbl_lick.innerHTML = defaults['lick']

        var tips = document.getElementById('tip_container');
        tips.appendChild(course_title);
        tips.appendChild(lbl_lick);

    }

    function labels() {
        createDefaultTooltips();
        var suffix = "";
        $('form label').each(function (index) {
            suffix = this.htmlFor;
            tip = $('#tip_' + suffix);
            this.title = (tip) ? tip.html() : '';
        });
    }

    function preventFormSubmit() {
        var forms = document.querySelectorAll('form');
        for (var i = 0; i < forms.length; i++) {
            forms[i].addEventListener('submit', function (event) {
                event.preventDefault();
            });
        }
    }

    function getCourses(e) {
        loading();
        google.script.run
            .withFailureHandler(onFailure)
            .withSuccessHandler(addListValues)
            .withUserObject(e)
            .get_sheet_names();
        labels()
    }

    function getLicks(e) {
        loading()
        var lick_input = document.getElementById('lbl_lick');
        var lick_list = document.getElementById('lick_names');
        var title = e.options[e.selectedIndex].text;
        if (lick_input.value !== "") lick_input.value = "";
        if (title == '--') {
            clearList(lick_list);
            return loading();
        }
        google.script.run
            .withFailureHandler(onFailure)
            .withSuccessHandler(addListValues)
            .withUserObject(lick_list)
            .get_licks_for_course(title);
    }

    function addListValues(values, el) {
        clearList(el);
        if (typeof values === 'undefined') return;
        for (var i = 0; i < values.length; i++) {
            if (values[i] === "") continue;
            var option = document.createElement("OPTION");
            option.value = values[i];
            option.text = values[i];
            el.appendChild(option);
        }
        loading()
    }

    function clearList(list) {
        if (list == null) return;
        // console.info(typeof list.options);
        for (i = list.options.length - 1; i >= 0; i--) {
            if (list.options[i].text !== '--') {
                list.options[i].remove();
            }
        }
        // console.info(list.options);
    }

    function onFailure(err) {
        var msg = `${err.name}  ${err.message}`;
        alert(msg);
        console.log(msg);
    }

    function onSuccess(val) {
        var msg = (val) ? 'Op Successful' : 'No Joy';
        alert(msg);
    }

    function doAction(btn) {
        var title = document.getElementById('course_title').value;
        var lick = document.getElementById('lbl_lick').value;
        var frm = document.getElementById('myForm');
        var frm_data = $('form').serializeArray().reduce(function (a, x) {
            a[x.name] = x.value;
            return a;
        }, {});
        loading();
        console.log(btn.name);
        switch (btn.name) {
            case 'reset':
                toggleInsert();
                $('#mychart').hide();
                break;
            case 'read':
                if (title !== '--' && lick !== '') {
                    google.script.run
                        .withFailureHandler(onFailure)
                        .withSuccessHandler(populateForm)
                        .get_lick(title, lick);
                    updateChartData();
                    break;
                }
                alert('Title and Lick required for this search')
                break;
            case 'dump':
                if (title !== '--') {
                    google.script.run
                        .withFailureHandler(onFailure)
                        .withSuccessHandler(output_table)
                        .read_all_values(title);
                    break;
                }
                alert('Choose A course')
                break;
            case 'delete':
                if (confirm(`Are you sure you want to delete lick: "${lick}"`)) {
                    google.script.run
                        .withFailureHandler(onFailure)
                        .withSuccessHandler(() => location.reload())
                        .delete_lick(title, lick);
                    loading();
                    document.getElementById('lbl_lick').value = "";
                }
                case 'update':
                    if (confirm(`Are you sure you want to update lick: "${lick}"`)) {
                        google.script.run
                            .withFailureHandler(onFailure)
                            .withSuccessHandler(loadChartData)
                            .update_lick(frm_data);
                    }
                    loading();
                    $('#mychart').show();
                    break;
                case 'create':
                default:
                    if (title !== '--' && lick !== '') {
                        google.script.run
                            .withFailureHandler(onFailure)
                            .withSuccessHandler((data) => {
                                if (Object.keys(data).includes('xs')) loadChartData(data);
                                loading();
                            })
                            .processForm(frm_data);
                        frm('reset');
                    }
        }
        loading();
    }

    function toggleInsert(name) {
        var toggle = (name === 'update');
        $('input[name=create]').toggle(!toggle);
        $('input[name=update]').toggle(toggle);
    }

    function populateForm(data) {
        if (!data) return;
        if (Object.keys(data).includes(['name', 'message'])) return onFailure(data);
        Object.entries(data).forEach(function (key, value) {
            value = key[1];
            key = key[0]
            if (key !== '') {
                var ctrl = $('#' + key);
                // alert(`${ctrl.prop('id')} (${ctrl.prop('type')}): ${value}`);
                switch (ctrl.prop("type")) {
                    case "radio":
                    case "checkbox":
                        ctrl.each(function () {
                            if ($(this).attr('value') !== value) $(this).attr("checked", value);
                        });
                        break;
                    case "number":
                    case "text":
                    default:
                        ctrl.val(value);
                }
            }
        });

        toggleInsert('update');
    }

    function updateChartData() {
        var title = document.getElementById('course_title').value
        var lick = document.getElementById('lbl_lick').value
        if (title !== '--' && lick !== '') {
            loading();
            google.script.run
                .withFailureHandler(onFailure)
                .withSuccessHandler(loadChartData)
                .update_chart(title, lick);
        }
    }

    function loadChartData(chart_data) {
        if (!chart_data) return;
        var ctx = document.getElementById('mychart').getContext('2d');
        if (window.lickChart) window.lickChart.destroy(); //removeChartData();
        window.lickChart = new Chart(ctx, genChartConfig(chart_data));
        loading();
    }

    function removeChartData() {
        console.dir(window.lickChart);
        // console.log(window.lickChart.data.datasets);
        window.lickChart.data.labels.pop();
        window.lickChart.data.datasets.forEach((dataset) => {
            dataset.data.pop();
        });
        console.dir(window.lickChart);
        window.lickChart.update();
    }

    function genChartConfig(chart_data) {
        return {
            type: 'bar',

            data: {
                labels: chart_data.xs,
                datasets: [{
                    data: chart_data.ys,
                }]
            },
            options: {
                legend: {
                    display: false,
                },
                title: {
                    display: true,
                    text: chart_data.title,
                    fontSize: 20,
                    fontStyle: 'bold'
                },
                responsive: true,
                scales: {
                    xAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: 'Attributes',
                            fontSize: 14,
                            fontStyle: 'bold'
                        },
                    }],
                    yAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: 'Scale (0 - 100)',
                            fontSize: 14,
                            fontStyle: 'bold'
                        },
                        ticks: {
                            suggestedMin: 0,
                            suggestedMax: 100,
                            step: 20
                        }
                    }]
                },
                elements: {
                    rectangle: {
                        backgroundColor: genRGBA(chart_data.xs.length, 1),
                        borderColor: genRGBA(chart_data.xs.length, 2),
                        borderWidth: 1

                    }
                }

            }
        };
    }

    function genRGBA(numCols, opacity) {
        var colColors = [];
        const getRand256 = () => {
            return Math.floor(Math.random() * 256)
        };
        for (var i = 0; i < numCols - 1; i++) {
            colColors.push(`rgba(${getRand256()}, ${getRand256()}, ${getRand256()}, ${opacity})`);
        }
        return colColors;
    }

    function loading(show) {
        $('#loader').toggle();
    }



    function loader() {
        preventFormSubmit();
        getCourses(document.getElementById('course_title'));
        test();
        toggleInsert();
    }

    function test(data) {
        loading();
        // alert("load")
    }

    window.addEventListener('load', loader);
</script>