<script>
    function output_table(data) {
        json = JSON.parse(data)
        // CREATE DYNAMIC TABLE.
        var table = document.createElement("table");
        var header = table.createTHead();
        var row = header.insertRow(0);
        var headers = Object.keys(json.records[0]);
        var cell;
        for (var i = 0; i < headers.length; i++) {
            cell = row.insertCell(i);
            cell.innerHTML = '<b>' + headers[i] + '</b>'
        }


        // ADD JSON DATA TO THE TABLE AS ROWS.
        for (var i = 0; i < json.records.length; i++) {
            cur_vals = Object.values(json.records[i]);
            tr = table.insertRow(-1);
            for (var j = 0; j < cur_vals.length; j++) {
                var tabCell = tr.insertCell(-1);
                tabCell.innerHTML = cur_vals[j];
            }
        }


        // FINALLY ADD THE NEWLY CREATED TABLE WITH JSON DATA TO A CONTAINER.
        var divContainer = document.getElementById("output");
        divContainer.innerHTML = "";
        divContainer.appendChild(table);
    }

    function createDefaultTooltips() {
        var defaults = {
            title: `Course Title 
                              The sheet names in the attached Spreadsheet`,
            lick: `Lick Name
                             Short Name of the lick 
                             (eg. Solo 1 Lick 7, S1L7,
                             Chorus 3 Lick 5, C3L5,
                             Lesson 1 Pattern 3, L1P3)`

        };
        var course_title = document.createElement("PRE");
        course_title.id = "tip_course_title";
        course_title.innerHTML = defaults['title'];

        var lbl_lick = document.createElement("PRE");
        lbl_lick.id = 'tip_lbl_lick';
        lbl_lick.innerHTML = defaults['lick']

        var tips = document.getElementById('tip_container');
        tips.appendChild(course_title);
        tips.appendChild(lbl_lick);

    }

    function labels() {
        createDefaultTooltips();
        var suffix = "";
        $('form label').each(function (index) {
            suffix = this.htmlFor;
            tip = $('#tip_' + suffix);
            this.title = (tip) ? tip.html() : '';
        });
    }

    function preventFormSubmit() {
        var forms = document.querySelectorAll('form');
        for (var i = 0; i < forms.length; i++) {
            forms[i].addEventListener('submit', function (event) {
                event.preventDefault();
            });
        }
    }

    function getCourses(e) {
        google.script.run
            .withFailureHandler(onFailure)
            .withSuccessHandler(addListValues)
            .withUserObject(e)
            .get_sheet_names();
        labels()
    }

    function getLicks(e) {
        var licks = document.getElementById('lick_names');
        licks.innerHTML = "";
        var title = e.options[e.selectedIndex].text;
        if (title == '--') return;
        google.script.run
            .withFailureHandler(onFailure)
            .withSuccessHandler(addListValues)
            .withUserObject(licks)
            .get_licks_for_course(title);
    }

    function addListValues(values, el) {
        clearList(el);
        if (typeof values === 'undefined') return;
        for (var i = 0; i < values.length; i++) {
            if (values[i] === "") continue;
            var option = document.createElement("OPTION");
            option.value = values[i];
            option.text = values[i];
            el.appendChild(option);
        }
    }

    function clearList(list) {
        if (list == null) return;
        console.info(list.nodeName);
        for (i = list.options.length - 1; i >= 0; i--) {
            if (list.options[i].text !== '--') list.remove(i);
        }
    }

    function onFailure(err) {
        alert('There was an error!' + err.message);
    }

    function onSuccess(val) {
        var msg = (val) ? 'Op Successful' : 'No Joy';
        alert(msg);
    }

    function doAction(btn) {
        var title = document.getElementById('course_title').value
        var lick = document.getElementById('lbl_lick').value
        var frm = $('form').serialize(); //$(btn).parent('form')[0]; 
        console.log('Form:');
        console.dir(frm);
        switch (btn.name) {
            case 'reset':
                if (frm) frm.trigger('reset');;
                break;
            case 'read':
                if (title !== '--' && lick !== '') {
                    toggleInsert('update');
                    google.script.run
                        .withFailureHandler(onFailure)
                        .withSuccessHandler(populateForm)
                        .get_lick(title, lick);
                    updateChartData();
                    break;
                }
                alert('Title and Lick required for this search')
                break;
            case 'dump':
                if (title !== '--') {
                    google.script.run
                        .withFailureHandler(onFailure)
                        .withSuccessHandler(output_table)
                        .read_all_values(title);
                    break;
                }
                alert('Choose A course')
                break;
            case 'delete':
                if (confirm(`Are you sure you want to delete lick: "${lick}"`)) {
                    google.script.run
                        .withFailureHandler(onFailure)
                        .withSuccessHandler(onSuccess)
                        .delete_lick(title, lick);
                    document.getElementById('lbl_lick').value = "";
                }
                case 'update':
                    toggleInsert();
                    if (confirm(`Are you sure you want to update lick: "${lick}"`)) {
                        google.script.run
                            .withFailureHandler(onFailure)
                            .withSuccessHandler(loadChartData)
                            .update_lick(frm);
                    }
                    $('#mychart').show();
                    break;
                case 'create':
                default:
                    // $('#mychart').hide();
                    if (title !== '--' && lick !== '') {
                        google.script.run
                            .withFailureHandler(onFailure)
                            .withSuccessHandler(onSuccess)
                            .processForm(frm);
                        frm.trigger('reset');
                    }
        }
    }

    function toggleInsert(name) {
        var toggle = (name === 'update');
        $('input[name=create]').toggle(!toggle)
        $('input[name=update]').toggle(toggle)

    }

    function populateForm(data) {
        Object.entries(data).forEach(function (key, value) {
            value = key[1];
            key = key[0]
            if (key !== '') {
                var ctrl = $('#' + key);
                // alert(`${ctrl.prop('id')} (${ctrl.prop('type')}): ${value}`);
                switch (ctrl.prop("type")) {
                    case "radio":
                    case "checkbox":
                        ctrl.each(function () {
                            if ($(this).attr('value') !== value) $(this).attr("checked", value);
                        });
                        break;
                    case "number":
                    case "text":
                    default:
                        ctrl.val(value);
                }
            }
        });
    }

    function updateChartData() {
        var title = document.getElementById('course_title').value
        var lick = document.getElementById('lbl_lick').value
        if (title !== '--' && lick !== '') {
            google.script.run
                .withFailureHandler(onFailure)
                .withSuccessHandler(loadChartData)
                .update_chart(title, lick);
        }
    }

    function loadChartData(chart_data) {
        var ctx = $('#mychart'); //document.getElementById('mychart').getContext('2d');
        var myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chart_data.xs,
                datasets: [{
                    label: chart_data.title,
                    data: chart_data.ys,
                    backgroundColor: genRGBA(chart_data.xs.length, 0.2),
                    borderColor: genRGBA(chart_data.xs.length, 1),
                    borderWidth: 1
                }]
            },
            options: {                
                
            }
        });
    }

    function genRGBA(numCols, opacity) {
        var colColors = [];
        const getRand256 = () => {
            return Math.floor(Math.random() * 256)
        };
        for (var i = 0; i < numCols - 1; i++) {
            colColors.push(`rgba(${getRand256()}, ${getRand256()}, ${getRand256()}, ${opacity})`);
        }
        return colColors;
    }

    function loader() {
        preventFormSubmit();
        getCourses(document.getElementById('course_title'));
        // test(); 
        toggleInsert();
    }



    function test(data) {
        //alert(data)
    }

    window.addEventListener('load', loader);
</script>